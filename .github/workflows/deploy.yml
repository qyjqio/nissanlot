name: éƒ¨ç½²GPSç³»ç»Ÿåˆ°æœåŠ¡å™¨

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: è®¾ç½®SSHå¯†é’¥
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} '
          # åœæ­¢ç°æœ‰æœåŠ¡
          if [ -d "/opt/gps-system" ]; then
            cd /opt/gps-system
            docker-compose down || true
          fi
          
          # ä¸‹è½½æœ€æ–°ä»£ç å¹¶éƒ¨ç½²
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/deploy.sh | bash
          
          # æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
          sleep 30
          if curl -k -s https://localhost >/dev/null 2>&1; then
            echo "âœ… éƒ¨ç½²æˆåŠŸ"
          else
            echo "âŒ éƒ¨ç½²å¯èƒ½å¤±è´¥"
            exit 1
          fi
        '
        
    - name: é€šçŸ¥éƒ¨ç½²ç»“æœ
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "ğŸ‰ GPSç³»ç»Ÿéƒ¨ç½²æˆåŠŸï¼"
        else
          echo "âŒ GPSç³»ç»Ÿéƒ¨ç½²å¤±è´¥ï¼"
        fi 